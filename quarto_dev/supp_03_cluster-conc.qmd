---
title: Cruise Cluster Concentration
---

Concentration of each morphogroup across the study period.
Shown are the integrated abundances from 0-600m

```{r}
rm(list = ls())
library(EcotaxaTools)
library(ggplot2)
library(ggpubr)
library(lubridate)
source('../R/tools.R')

conc_data <- readRDS('../data/03_cluster-conc.rds') |> 
  lapply(bin_format) |> 
  lapply(function(x) x[which(x$max_d <= 600),1:3]) # this is really ugly bug fix 1:3, need to fix in package
  
uvp_data_meta <- readRDS('../data/01_uvp-trim-final.rds')$meta
uvp_data_meta$cruise_id <- paste0(uvp_data_meta$stationid,
                                  uvp_data_meta$programid)

uvp_data_meta$dateabv <- paste(year(uvp_data_meta$sampledate),
                               month(uvp_data_meta$sampledate),
                               '01', sep = '-') |> 
  as.Date()

cruise_casts <- vector('list', length(unique(uvp_data_meta$dateabv)))
names(cruise_casts) <- unique(uvp_data_meta$dateabv)
for(i in 1:length(cruise_casts)) {
  cruise_casts[[i]] <- uvp_data_meta$profileid[which(uvp_data_meta$dateabv == names(cruise_casts)[i])]
}

avg_conc <- conc_data |> 
  average_casts(cruise_casts) |> 
  lapply(integrate_all, need_format = T, subdivisions = 1000) |> 
  lapply(intg_to_tib) |> 
  list_to_tib('date')


avg_conc$date <- avg_conc$date |> as.Date()

intg_plot_early <- ggplot(avg_conc[year(avg_conc$date) < 2020,]) +
  geom_bar(aes(x = date,
               y = intg,
               fill = taxa),
           stat = 'identity',
           position = 'dodge') +
  scale_fill_manual(values = gg_cbb_col(4)) +
  scale_x_date(date_labels = '%Y-%m',
               date_breaks = '1 month') +
  scale_y_continuous(limits = c(0,350), expand = c(0,0)) +
  labs(x = "", y = 'Integrated Abundance', fill = "") + 
  theme_pubr() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))

intg_plot <- ggplot(avg_conc[year(avg_conc$date) >= 2020,]) +
  geom_bar(aes(x = date,
               y = intg,
               fill = taxa),
           stat = 'identity',
           position = 'dodge') +
  scale_fill_manual(values = gg_cbb_col(4)) +
  scale_x_date(date_labels = '%Y-%m',
               date_breaks = '1 month') +
  scale_y_continuous(limits = c(0,350), expand = c(0,0)) +
  labs(x = "", y = 'Integrated Abundance', fill = "") + 
  theme_pubr() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))

ggarrange(intg_plot_early,
          intg_plot + theme(axis.title.y = element_blank(),
                            axis.text.y = element_blank(),
                            axis.line.y = element_blank(),
                            axis.ticks.y = element_blank()),
          common.legend = TRUE,
          widths = c(0.2,0.80),
          nrow = 1)
```