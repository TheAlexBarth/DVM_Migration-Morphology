---
title: Morphogroup Occupancy Model
---

# Methodology:

The full rationale and background on site-occupancy modelling can be found [here](./main_05_all-copepod-occupancy.qmd). Following the verification of the technique, we applied these models to determine water column occupancy for each of the different morphogroups. This model followed the same structure as the all-copepod model, where occupancy ($\psi$) was assumed to be a unique, independent probability for each depth-bin and each morphogroup. As such this is a simple extension of the previous model, just ran for each individual morphogroup at site $i$, in depth-bin $db$, at each time of day $tod$. Again these models were ran separately for the epipelagic, upper mesopelagic, and low mesopelagic. 

$$
Y_{ij,db,tod,mg} \sim Bernoilli(p_{ij,tod,mg}*z_{i,db,tod,mg})
$$

$$
z_{i,db,tod,mg} \sim Binomial(\psi_{db,tod,mg})
$$

$$
logit(p_{ij,tod,mg}) \sim a_0 + a_{vs,tod,mg} * vs_{ij}
$$

The same priors were used in this model as described previously. All model conditions and MCMC simulation methods were consistent as well.

# Key Figures and Takeaways:
```{r}

rm(list = ls())
library(ggplot2)
library(ggpubr)
library(wiqid)
library(EcotaxaTools)
source('../R/tools.R')


db <- readRDS('../data/05_db-list.rds')
epi_mod_output <- readRDS('../data/05_cluster-occ-mod-epi.rds')
tmeso_mod_output <- readRDS('../data/05_cluster-occ-mod-tmeso.rds')
bmeso_mod_output <- readRDS('../data/05_cluster-occ-mod-bmeso.rds')


# |- Extact credible intervals from models -------------

psi_extract <- function(model, tod, min_d, max_d, db = db) {
  db_length <- ncol(model[[tod]]$sims.list$psi)
  
  out_df <- data.frame(
    db = db_decode(c(1:db_length), tod, min_d, max_d, db = db),
    mean = rep(NA, db_length),
    low = rep(NA, db_length),
    high = rep(NA, db_length)
  )
  
  for(i in 1:db_length) {
    out_df[i,-1] <- c(mean(model[[tod]]$sims.list$psi[,i]),
                      hdi(model[[tod]]$sims.list$psi[,i]))
  }
  return(out_df)
}


occ_pred <- vector('list', 4)
for(i in 1:4) {
  for(tod in c('day', 'night')) {
    occ_pred[[i]][[tod]] <- do.call(rbind,list(
      psi_extract(epi_mod_output[[i]],
                  tod, 0, 200,
                  db = db[[i]]),
      psi_extract(tmeso_mod_output[[i]],
                  tod, 200, 600,
                  db = db[[i]]),
      psi_extract(bmeso_mod_output[[i]],
                  tod, 600, 1200,
                  db = db[[i]]))) |> 
      bin_format()
  }
}

names(occ_pred) <- c(1:4)
occ_pred <- occ_pred |> 
  lapply(list_to_tib, 'tod') |> 
  list_to_tib('cluster')


###
# Plotting ######
###
ribbon_plot <- function(cluster) {
  plot_data <- occ_pred[occ_pred$cluster == cluster,]
  
  out_plot <- ggplot(plot_data) +
    geom_ribbon(aes(x = mp,
                        y = mean,
                        ymin = low,
                        ymax = high,
                        fill = tod,
                    color = tod),
                alpha = 0.5) +
    geom_line(aes(x = mp,
                  y = mean,
                  color = tod),
              linewidth = 1,
              alpha = .75) +
    facet_wrap(~tod)+
    scale_x_reverse() +
    scale_fill_manual(values = c(dn_cols['day'],dn_cols['night'])) +
    scale_color_manual(values = c(dn_cols['day'],dn_cols['night'])) +
    coord_flip()+
    theme_pubr() +
    labs(x = 'Depth [m]', y = "Occupancy") +
    theme(legend.position = 'none')
  return(out_plot)
}

# point_plot <- function(cluster) {
#   plot_data <- occ_pred[occ_pred$cluster == cluster,]
#   
#   out_plot <- ggplot(plot_data) +
#     geom_pointrange(aes(x = mp,
#                         y = mean,
#                         ymin = low,
#                         ymax = high,
#                         color = tod),
#                     position = position_dodge(width = 5)) +
#     scale_x_reverse() +
#     scale_fill_manual(values = c(dn_cols['day'],dn_cols['night'])) +
#     scale_color_manual(values = c(dn_cols['day'],dn_cols['night'])) +
#     coord_flip()+
#     theme_pubr() +
#     labs(x = 'Depth [m]', y = "Occupancy") +
#     theme(legend.position = 'none')
#   return(out_plot)
# }

ribbon_occupancy <- vector('list',4)
# point_occupancy <- vector('list', 4)
for(i in 1:4) {
  ribbon_occupancy[[i]] <- ribbon_plot(i)
  # point_occupancy[[i]] <- point_plot(i)
}

ggarrange(ribbon_occupancy[[1]],
          ribbon_occupancy[[2]] + theme(axis.title.y = element_blank(),
                                        axis.text.y = element_blank()),
          ribbon_occupancy[[3]] + theme(axis.title.y = element_blank(),
                                        axis.text.y = element_blank()),
          ribbon_occupancy[[4]] + theme(axis.title.y = element_blank(),
                                        axis.text.y = element_blank()),
          ncol = 4)

# ggarrange(point_occupancy[[1]],
#           point_occupancy[[2]] + theme(axis.title.y = element_blank()),
#           point_occupancy[[3]] + theme(axis.title.y = element_blank()),
#           point_occupancy[[4]] + theme(axis.title.y = element_blank()),
#           ncol = 4)

```

Generally, across all morphogroups, it can be seen that the credible intervals (95% high density interval of the posterior distribution) for copepod occupancy are very wide. Often ranging from 25% to 100%. However, there are some clear trends consistent with DVM hypotheses. Notably, there is an increased nighttime occupancy for all morphogroups from the 40m to 140m. For depth bins in those regions, the mean posterior occupancy ranges from 73% to 92%, indicating there is a high likelihood all morphogroups will be found in that region at night. There is lower daytime occupancy over that same region, however this varies by morphogroup. For Morphogroup 1, the mean posterior occupancy ranges from 52% (at 80-100m) to 73% (at 60-80m). Morphogroup 2, the mean posterior occupancy ranges from 60% to 80%. For morphogroups 3 and 4, the posterior mean occupancy is similar to the nighttime estimates. This finding suggests that the larger morphogroups (1 & 2) will are less likely to be found near the surface during the daytime as compared to the smaller morphogroups. Yet again, we detect no clear difference between the darker morphogroup and the lighter morphogroup.

\n\n
A possilbe reason for the wide range of occupancy variables is the fact we have yet to account for environmental influences on occupancy across different cruises (sites). This is investigated in [Figure 7](./main_07_environmental-effect-model.html)


The full occupancy credible intervals for each morphotype and depthbin can be seen below:

```{r}
library(DT)
library(dplyr)

occ_pred |> 
  select(DepthBin = db, BinMidPoint = mp,
         lowerCI = low, meanPsi = mean, upperCI = high, TimeOfDay = tod, 
         MorphoGroup = cluster) |> 
  datatable(filter = 'top')
```

